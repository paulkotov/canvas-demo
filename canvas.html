<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Snowflakes (Legacy) - Canvas Drawing App</title>
  <link rel="stylesheet" href="css/styles.css">
</head>

<body>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      min-width: 100vw;
      min-height: 100vh;
      overflow: hidden;
    }

    #canvas {
      background-color: black;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
      min-height: 100vh;
      /* max-width: 100vw; */
      /* max-height: 100vh; */
    }

    .controls__container {
      position: absolute;
      z-index: 10;
    }

    .controls__form {
      height: 32px;
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      /* align-items: center; */
      gap: 8px;
    }

    .controls__form_input {
      min-width: 100px;
      font-size: medium;
    }

    .controls__form_button {
      min-width: 100px;
    }

    .controls__form_checkbox {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 8px;
      color: #fff;
    }
  </style>
  <div class="controls__container">
    <form name="controls__form" class="controls__form">
      <div class="controls__group">
        <label class="controls__label">Branches</label>
        <input class="controls__input" type="number" name="branches" placeholder="2" min="1" max="5" value="2">
      </div>
      <div class="controls__group">
        <label class="controls__label">Spread</label>
        <input class="controls__input" type="number" name="spread" placeholder="0.5" step="0.1" min="0.1" max="1.5"
          value="0.5">
      </div>
      <div class="controls__group">
        <label class="controls__label">Sides</label>
        <input class="controls__input" type="number" name="sides" placeholder="5" min="3" max="12" value="5">
      </div>
      <div class="controls__group">
        <label class="controls__label">Scale</label>
        <input class="controls__input" type="number" name="scale" placeholder="0.7" step="0.1" min="0.3" max="1"
          value="0.7">
      </div>
      <div class="controls__group">
        <label class="controls__label">Angle</label>
        <input class="controls__input" type="number" name="angle" placeholder="0" min="0" max="180" value="0">
      </div>
      <label class="controls__checkbox">
        <input type="checkbox" name="randomInsert">
        <span>Random Position</span>
      </label>
      <button class="controls__btn" type="submit">Draw</button>
      <button class="controls__btn controls__btn--secondary" type="reset">Clear</button>
    </form>
  </div>
  <script type="module">
    import { Canvas } from './js/canvas.js';
    import { get } from './js/utils.js';

    class Fractal {
      context = null;
      params = {};

      constructor(canvasRef, fractalParams) {
        if (!canvasRef || !(canvasRef instanceof HTMLCanvasElement)) {
          throw Error('Error with accessing canvas');
        }
        this.width = canvasRef.width;
        this.height = canvasRef.height;

        const ctx = canvasRef.getContext('2d');
        ctx.lineWidth = 10;
        ctx.lineCap = 'round';
        ctx.shadowColor = 'rgba(100, 150, 255, 0.5)';
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 0;
        ctx.shadowBlur = 15;
        this.context = ctx;

        this.params.size = get(fractalParams, 'size', 300);
        this.params.sides = get(fractalParams, 'sides', 5);
        this.params.maxLevel = get(fractalParams, 'maxLevel', 2);
        this.params.scale = get(fractalParams, 'scale', 0.7);
        this.params.spread = get(fractalParams, 'spread', 0.5);
        this.params.branches = get(fractalParams, 'branches', 2);
        this.params.baseHue = get(fractalParams, 'baseHue', 200);
      }

      #drawBranch(level) {
        // TODO: add max level to params
        if (level === undefined || level > this.params.maxLevel) {
          return;
        }
        const hueShift = (level / this.params.maxLevel) * 120;
        this.context.strokeStyle = `hsl(${this.params.baseHue + hueShift}, 100%, 50%)`;

        this.context.beginPath();
        this.context.moveTo(0, 0);
        this.context.lineTo(this.params.size, 0);
        this.context.stroke();

        for (let i = 0; i < this.params.branches; i++) {
          this.context.save();
          this.context.translate(this.params.size - (this.params.size / this.params.branches) * i, 0);
          this.context.rotate(this.params.spread);
          this.context.scale(this.params.scale, this.params.scale);
          this.#drawBranch(level + 1);
          this.context.restore();

          this.context.save();
          this.context.translate(this.params.size - (this.params.size / this.params.branches) * i, 0);
          this.context.rotate(-this.params.spread);
          this.context.scale(this.params.scale, this.params.scale);
          this.#drawBranch(level + 1);
          this.context.restore();
        }
      }

      draw(position, scale, rotate) {
        this.context.save();
        this.context.translate(
          get(position, 'x', this.width / 2),
          get(position, 'y', this.height / 2)
        );
        const scaleValue = scale || this.params.scale || 1;
        this.context.scale(scaleValue, scaleValue);
        this.context.rotate(rotate || 0);

        for (let i = 0; i < this.params.branches; i++) {
          this.context.rotate((Math.PI * 2) / this.params.branches);
          this.#drawBranch(0);
        }
        this.context.restore();
      }
    }

    window.addEventListener('load', function () {
      const canvas = new Canvas('canvas');
      const form = document.querySelector('form[name="controls__form"]');

      // Draw initial fractal
      // new Fractal(canvas.canvas, { baseHue: 60, sides: 5, maxLevel: 3 }).draw();

      form.addEventListener('submit', function (e) {
        e.preventDefault();
        const branchesInput = form.querySelector('input[name="branches"]');
        const spreadInput = form.querySelector('input[name="spread"]');
        const sidesInput = form.querySelector('input[name="sides"]');
        const angleInput = form.querySelector('input[name="angle"]');
        const scaleInput = form.querySelector('input[name="scale"]');
        // const 
        const branches = branchesInput.value;
        const spread = spreadInput.value;
        const sides = sidesInput.value;
        const randomInsertInput = form.querySelector('input[name="randomInsert"]');
        const isRandomInsert = randomInsertInput.checked;
        let points = undefined;
        // need save
        let position = {
          x: canvas.canvas.width / 2,
          y: canvas.canvas.height / 2
        }
        if (isRandomInsert) {
          position = {
            x: Math.random() * canvas.canvas.width,
            y: Math.random() * canvas.canvas.height
          };
        }
        // let rotation = 0;
        // if (angleInput.value) {
        //   rotation = angleInput.value * Math.PI / 180;
        // }
        // new Fractal(canvas.canvas, { baseHue: 60, branches, spread, sides, maxLevel: 3 }).draw(points, 1, 0.25, rotation);

        const rotation = angleInput * Math.PI / 180;
        new Fractal(canvas.canvas, {
          baseHue: 60,
          branches,
          spread,
          sides,
          scale: scaleInput.value,
          maxLevel: 3
        }).draw(position, 1, rotation);
      });

      form.addEventListener('reset', function (e) {
        e.preventDefault();
        // get form controls
        // const form = document.querySelector('form[name="controls__form"]');
        const branchesInput = form.querySelector('input[name="branches"]');
        const spreadInput = form.querySelector('input[name="spread"]');
        const sidesInput = form.querySelector('input[name="sides"]');
        const angleInput = form.querySelector('input[name="angle"]');
        const scaleInput = form.querySelector('input[name="scale"]');
        branchesInput.value = '';
        spreadInput.value = '';
        sidesInput.value = '';
        angleInput.value = '';
        scaleInput.value = '';
        canvas.clear();
        form.reset();
      });

      window.addEventListener('resize', () => canvas.resize());
    });
  </script>
</body>

</html>